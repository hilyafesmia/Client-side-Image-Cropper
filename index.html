<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-side Image Cropper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
        }
        body {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        #crop-container {
            position: relative;
            max-width: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1e293b;
            border-radius: 8px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            min-height: 300px;
        }
        #preview-img {
            display: block;
            max-width: 100%;
            max-height: 70vh;
            user-select: none;
            -webkit-user-drag: none;
        }
        #crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        #crop-mask {
            fill: rgba(0, 0, 0, 0.75);
            fill-rule: evenodd;
        }
        #crop-frame {
            position: absolute;
            border: 2px solid var(--primary);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            cursor: move;
            pointer-events: all;
            box-sizing: border-box;
        }
        #crop-frame::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 1px solid rgba(255,255,255,0.3);
            background-image: 
                linear-gradient(to right, rgba(255,255,255,0.2) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.2) 1px, transparent 1px);
            background-size: 33.33% 33.33%;
            pointer-events: none;
        }
        .custom-radio:checked + label {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-blue-400">CinemaCrop</h1>
            <p class="text-slate-400 mt-2">Professional cinematic cropping at original resolution.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Controls Column -->
            <div class="lg:col-span-1 space-y-6 bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                <div>
                    <label class="block text-sm font-medium mb-2">1. Select Image</label>
                    <input type="file" id="file-input" accept="image/*" class="block w-full text-sm text-slate-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-600 file:text-white
                        hover:file:bg-blue-700 cursor-pointer">
                </div>

                <div class="space-y-3">
                    <label class="block text-sm font-medium">2. Aspect Ratio</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="setRatio(1.85)" class="ratio-btn px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-left flex justify-between items-center transition">
                            <span>Widescreen</span>
                            <span class="text-xs opacity-60">1.85:1</span>
                        </button>
                        <button onclick="setRatio(2.35)" class="ratio-btn px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-left flex justify-between items-center transition">
                            <span>Anamorphic</span>
                            <span class="text-xs opacity-60">2.35:1</span>
                        </button>
                        <button onclick="setRatio(2.6)" class="ratio-btn px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-left flex justify-between items-center transition">
                            <span>Cinematic</span>
                            <span class="text-xs opacity-60">2.6:1</span>
                        </button>
                        <button onclick="setRatio(2.77)" class="ratio-btn px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-left flex justify-between items-center transition">
                            <span>Cinerama</span>
                            <span class="text-xs opacity-60">2.77:1</span>
                        </button>
                        <button onclick="toggleCustom(true)" class="ratio-btn px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-left flex justify-between items-center transition">
                            <span>Custom</span>
                            <span class="text-xs opacity-60">X:Y</span>
                        </button>
                    </div>

                    <div id="custom-ratio-input" class="hidden mt-2 p-3 bg-slate-900 rounded-lg space-y-2 border border-slate-700">
                        <div class="flex items-center gap-2">
                            <input type="number" id="custom-w" value="16" step="0.1" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" placeholder="W">
                            <span>:</span>
                            <input type="number" id="custom-h" value="9" step="0.1" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" placeholder="H">
                        </div>
                        <button onclick="applyCustomRatio()" class="w-full bg-blue-600 py-1 rounded text-sm font-bold">Apply</button>
                    </div>
                </div>

                <div class="pt-4 border-t border-slate-700">
                    <button id="download-btn" disabled class="w-full bg-emerald-600 disabled:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed py-3 rounded-lg font-bold shadow-lg hover:bg-emerald-500 transition-all flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Download Crop
                    </button>
                    <p class="text-[10px] text-center text-slate-500 mt-2 uppercase tracking-widest">Processed locally</p>
                </div>
            </div>

            <!-- Preview Column -->
            <div class="lg:col-span-3">
                <div id="crop-container" class="relative">
                    <div id="empty-state" class="text-slate-500 text-center p-20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p>Upload an image to start cropping</p>
                    </div>
                    <img id="preview-img" src="" alt="" class="hidden">
                    <div id="crop-frame" class="hidden"></div>
                </div>
                
                <div class="mt-4 flex flex-wrap gap-4 text-sm text-slate-400">
                    <div id="info-res">Original: -</div>
                    <div id="info-crop-res">Crop: -</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden canvas for processing -->
    <canvas id="internal-canvas" class="hidden"></canvas>

    <script>
        const fileInput = document.getElementById('file-input');
        const previewImg = document.getElementById('preview-img');
        const cropFrame = document.getElementById('crop-frame');
        const container = document.getElementById('crop-container');
        const emptyState = document.getElementById('empty-state');
        const downloadBtn = document.getElementById('download-btn');
        const customInputArea = document.getElementById('custom-ratio-input');
        
        const infoRes = document.getElementById('info-res');
        const infoCropRes = document.getElementById('info-crop-res');

        let originalImage = new Image();
        let currentRatio = 1.85; // Default
        let cropState = {
            top: 0,
            left: 0,
            width: 0,
            height: 0
        };

        let isDragging = false;
        let startX, startY;

        // Init
        fileInput.addEventListener('change', handleFile);
        downloadBtn.addEventListener('click', downloadCrop);

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                originalImage.onload = () => {
                    previewImg.src = event.target.result;
                    previewImg.classList.remove('hidden');
                    cropFrame.classList.remove('hidden');
                    emptyState.classList.add('hidden');
                    downloadBtn.disabled = false;
                    
                    infoRes.innerText = `Original: ${originalImage.width} x ${originalImage.height}`;
                    
                    // Reset crop to center with current ratio
                    initCrop();
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function setRatio(val) {
            currentRatio = val;
            toggleCustom(false);
            if (originalImage.src) initCrop();
        }

        function toggleCustom(show) {
            customInputArea.classList.toggle('hidden', !show);
        }

        function applyCustomRatio() {
            const w = parseFloat(document.getElementById('custom-w').value);
            const h = parseFloat(document.getElementById('custom-h').value);
            if (w > 0 && h > 0) {
                currentRatio = w / h;
                initCrop();
            }
        }

        function initCrop() {
            // Calculate display dimensions
            const displayW = previewImg.clientWidth;
            const displayH = previewImg.clientHeight;
            
            let frameW, frameH;

            // Fit ratio inside image area
            if (displayW / displayH > currentRatio) {
                // Image is wider than crop
                frameH = displayH;
                frameW = frameH * currentRatio;
            } else {
                // Image is taller than crop
                frameW = displayW;
                frameH = frameW / currentRatio;
            }

            // Center it
            cropState.width = frameW;
            cropState.height = frameH;
            cropState.left = (displayW - frameW) / 2;
            cropState.top = (displayH - frameH) / 2;

            updateFrameUI();
        }

        function updateFrameUI() {
            // Offset by the image's position within container
            const imgRect = previewImg.getBoundingClientRect();
            const contRect = container.getBoundingClientRect();

            const offsetLeft = imgRect.left - contRect.left;
            const offsetTop = imgRect.top - contRect.top;

            cropFrame.style.width = `${cropState.width}px`;
            cropFrame.style.height = `${cropState.height}px`;
            cropFrame.style.left = `${cropState.left + offsetLeft}px`;
            cropFrame.style.top = `${cropState.top + offsetTop}px`;

            // Calculate actual crop resolution
            const scale = originalImage.width / previewImg.clientWidth;
            const actualW = Math.round(cropState.width * scale);
            const actualH = Math.round(cropState.height * scale);
            infoCropRes.innerText = `Crop: ${actualW} x ${actualH}`;
        }

        // Dragging Logic
        cropFrame.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', drag);
        window.addEventListener('mouseup', endDrag);

        // Touch support
        cropFrame.addEventListener('touchstart', (e) => startDrag(e.touches[0]));
        window.addEventListener('touchmove', (e) => drag(e.touches[0]));
        window.addEventListener('touchend', endDrag);

        function startDrag(e) {
            if (!originalImage.src) return;
            isDragging = true;
            startX = e.clientX - cropState.left;
            startY = e.clientY - cropState.top;
        }

        function drag(e) {
            if (!isDragging) return;

            let nextX = e.clientX - startX;
            let nextY = e.clientY - startY;

            // Boundaries
            const maxLeft = previewImg.clientWidth - cropState.width;
            const maxTop = previewImg.clientHeight - cropState.height;

            cropState.left = Math.max(0, Math.min(nextX, maxLeft));
            cropState.top = Math.max(0, Math.min(nextY, maxTop));

            updateFrameUI();
        }

        function endDrag() {
            isDragging = false;
        }

        async function downloadCrop() {
            const canvas = document.getElementById('internal-canvas');
            const ctx = canvas.getContext('2d');

            const scale = originalImage.width / previewImg.clientWidth;
            
            const sx = cropState.left * scale;
            const sy = cropState.top * scale;
            const sWidth = cropState.width * scale;
            const sHeight = cropState.height * scale;

            canvas.width = sWidth;
            canvas.height = sHeight;

            // High quality scaling settings
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            ctx.drawImage(originalImage, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);

            // Export
            try {
                const dataUrl = canvas.toDataURL('image/png', 1.0);
                const link = document.createElement('a');
                link.download = `CinemaCrop_${Math.round(currentRatio*100)/100}_${Date.now()}.png`;
                link.href = dataUrl;
                link.click();
            } catch (err) {
                console.error("Export failed", err);
                // Use a message box instead of alert
                const msg = document.createElement('div');
                msg.className = "fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white p-4 rounded shadow-xl z-50";
                msg.innerText = "Export failed. This might happen with very large images in some browsers.";
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 4000);
            }
        }

        // Handle window resize to keep crop in sync
        window.addEventListener('resize', () => {
            if (originalImage.src) {
                // Re-calculating center might be annoying if user moved it, 
                // but necessary if display size changes drastically.
                // For simplicity, we just keep the frame centered on resize.
                initCrop();
            }
        });
    </script>
</body>
</html>
